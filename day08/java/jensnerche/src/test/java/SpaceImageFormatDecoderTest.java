import static org.junit.jupiter.api.Assertions.assertArrayEquals;
import static org.junit.jupiter.api.Assertions.assertEquals;

import java.util.ArrayList;
import java.util.List;

import org.junit.jupiter.api.Test;

class SpaceImageFormatDecoderTest {

  @Test
  void thatPixelsWereAssignedToLayers() {
    var input = "123456789012";

    List<int[]> layers = toLayers(input, 3, 2);

    assertEquals(2, layers.size());
    assertArrayEquals(new int[]{1,2,3,4,5,6}, layers.get(0));
    assertArrayEquals(new int[]{7,8,9,0,1,2}, layers.get(1));
  }

  @Test
  void thatLayerWithFewest0IsFound() {
    var input = "123456789012";
    List<int[]> layers = toLayers(input, 3, 2);

    var layerWithFewest0 = findLayerWithFewest0(layers);

    assertArrayEquals(new int[]{1,2,3,4,5,6}, layerWithFewest0);
  }

  @Test
  void thatCorruptionCheckIsCalculated() {
    var input = "123456789012";
    List<int[]> layers = toLayers(input, 3, 2);
    var layerWithFewest0 = findLayerWithFewest0(layers);

    int checkProduct = calculateCheckProduct(layerWithFewest0);

    assertEquals(1, checkProduct);
  }

  @Test
  void thatLayersWereCombined() {
    var input = "0222112222120000";
    List<int[]> layers = toLayers(input, 2, 2);

    var combinedLayer = combine(layers);

    assertArrayEquals(new int[]{0,1,1,0}, combinedLayer);
    printLayer(combinedLayer, 2, 2);
  }



  private static final String day08Input = "222022012222222222222222222220222202222212202222222222220022220221222222222122222222222222222022122222212220202210222222122222222222222002222121222022222022002212222222222222222221222222222212222222222222220122221222222222222122222222222222222022222222202222212201222222022222222222222102222222222022222222102222222222222222222222222212222212222222222222220122222222222222222122222222222222222022022220212222202220222222222222222222222122222020222222222122222202222222222222222222222202222212202222222222222222221221222222222022222222222222222222022221222222222221222222222222222222222022222121222222222122202202222222222222222220222212222202012222222222220222222221222222222222222222222122222122222220202222212212222222222222222222222202222021222022222222012202222222222222222221222202222202112222202222222222220222222222222222222222222122222222222222212220222212222222122222222222222122222120222022222122112202222222222222222222222222222212212222222222222222221220222222222222222222222122222022222212222222212212222222122222222222222122222122222222222222102202222222222222222222222212222202212222212222221022220221222222222022222222222222222222022200212220212212222222122222222222222102222121022222222022002202222222222222222220222202222202002222212222220222221221212222222022222222222022222222022212212222202220222222122222222222222122222022222222222222102202222222222222222222222202222202012222212222221022220222222222222222222222222022222122122210212222212222222222122222222222222202222222222022222022022202222222222222222221222212222212012222222222222022221222222222222022222222222022222222022210222220202222222222122222222202222202222220222222212122022202222222222222222222222212222212002222212222220022220221212222222222222222222022222022122202202221222221222222022222222202222002222021222022212122002202222222222222222222222202222212012222222222222222220221222222222122222222222022222022122020212222212202222222222222222212222222222120122122202022202212222222222222222222222202222222102222222222220022220222202222222122222222222022222022122021212221202202222222122222222212222122222021222122222022222202222222222222222220222202222212222222202222221222221220202222222022222222222222222222022122212221222211212222122222222212222012222020022022212122102222222222222222222221222212222212202222212222221122221221202222222122222222222222222222122011202222222202212222222222222222222002222220022122222222202202222222222222222220222202222202022222202222220122221221202222222122222222202022222022022000222221212210202222022222222212222002222120022022212122012202222222222222222220222212222212002222222222221122221220212222222022222222212122222022122022222222222220222222222222222202222221222221222122202122002222222222222222222220222212022222002222202222221222221222212222222022222222222222222222022001222222222221202222122222222202222122202222022122222022202222222222222222222221222222022222222222222222221022221221222222222122222222202022222022222021222222212212222222022222222222222222222020122122202022002202222222222222222220222202022222112222202222221022221220202222222122222222202222222022122002202222212221202222122222222202222111212120022222222122122212222222222222222222222222022202112202202222221222220220222222222022222222202222222022122220202221202200222222022222222202222201222221022122212122112212222222222222222222222222022222002202212222222022220222202222222022222222212022222222122210202221212212212222022222222212222220212021222222212122122222222222222222222221222202122202222212212222220222222221222222222222222222222022222222222102222222222201222222122222222202222120212122222122222222102222222222222222222221222202122212222212202222221022222220222222222222222222222022202122222200002222212210202222222222222222222101222220022122212122222222222222222222222020222212222212012212202222220022222220202222222122202022212122202022122020202222202210212222222222222202222222212021122122202122022202222222222222222120222202022202202202202222221122221222222222222222212022212222202122222120112221222201222222222222222212222120222020022022222022022212222222222222222022220202222212112202222222221222222220222222222122222222202222212022122000222220222220202222022222222202222202202121022222212022102202222222222222222220220212122202012210202222220022222220212222222222202202212222212222122012112222202220202222120222222212222110212220222222222222222202222222222222222120222222122212222201212222222222221222212222222222202112222022212122222221202221202222222222221222222222222122222022222222212022112222222222222222222122220202122202202200222222221122220220202222222222212002202122202122022221112220202202212222122222222212222111202221222122202222102202222222222222222121220212222212202212202222221122221220202222222022202012210022222222222201022220212221202222122222222222222101222220122022202222202222222222222222222022220222122202222220202222220222222222212222022222212202212022202122222011112222222222212222120222222222222222212122022222222122212222222222222222222020220222122212122210212222220222221220202222022222222202212022202022022021212222202201212222021222222222222002222020122022212022112222222222222222222121221202122222102202222222222222221220222222222122212212211122222022022100012220222220222222021222222222222122222022022022222122102202222222222222222220221222222222112210212222221022220222222222122222222022211122212222122002212222202222202222122222222222222101222021222022212022122202222222222222222222222222202202002212222222222122222222202222022222202012222022222222122121002221202200202222220222222212222221202020022222222122122222222222222122222220220212102212002221202222222022220201112222222122222222221122222122122222112222222212202222020222222202222111212121022222222222022212222222222222222222221202010202202210222222221122222221112222222022212012220222212122022110102222212211212222122222222212222221212222222122212220222202222222222222222121220222011222202220222222222022221202012222222122222012202222202122222202022221222202202222122222222212222110212020022022222022022202222222222022222221220222201222102202202222221222220222222222122021212022222022202122022122122221212210212222022222222202222120212120022022222222112212222222222022222122220202110222022200212222221122211222202222122120222002211122202222122101002220202200202220121222222222222201202020222022222021012222222222222022222221220212101222212201211222221020221200012222222122202002221222222222222000102221202220202220121222222212222202202120022022222121212212222222222122222222220212012202202212201222222022211222002222122121202112220102212022122002122221212202212220221222222212222011222221222022222020112202222222222022222021221222111202212200201222221221212221202222122022212212212022212222122101202222202200222220120222222202222001202220122122212122222222222222222022220120222201000222212221212222220021200222212222022221202002220212212022022110222222212211202221122222222202222012202011222022202221022212222222222122220020222212220222002200212222220220212212212222122020222112211122222022012111202221202222202221020222222202222211222011022022202221112222222222222122220121222202121202112211222222220220222210012222122221212022220022212022112200212220202212212221120222222202202000212202122122222121002212222222222222222120222211212202122201210222222020200222022222222121212112221022222022212020202220222200212220020222222222222112222100122122202021202212222221222222220122221212202202112211212222221021210201002222222220212112221222202222002021122220222220212221222222222202212012222022022222222220112212222222222122222021222212221212122210222222221120211221102222022221222202200202222022022101202221222212212220020222222202202222202122122022212122102202222222222022222220222221202202212211200222222021200220212222222120222212220212222222212102002222212210202221121222222202122120202010022022202220022222222121222122222220222221022222002210220222021020211211002222122121202112201012212022022220212221212222202221020222222222002021222012222222222122002202222222222222221221222201222222202220212222121220222221210222122120222102212202102122102020002222202221202220220222222222202221201202222122222222002222222120222122220020220212122212212212202222222121212202202222222020212222220222222222102102202221212212202222120222222202222112212220022122202020022222222021222222221122220221221222012220210222121220220201020222122120222102211102222122212020122222212210212220020222222222002112200200022122202122212212222121222022222121222211010222202212201222121122201210001222122120222002202212002122002222212220222221222222122222222202102001201220022222202022022222222121222122220020220220122222222202211222020121222200000222222020202222212122022122122021212221222200222222221222222212212002201012122022212021212202202221222022222220221221100222022221202222021021200222221222122122202012200122012221022211222221202220202220220222222212212202220011022012212021022202222222222022222120220212102212002202211222020120010212200222022021222212212212002120222000112222222210202221220222222212222002201102112002222221102202212220222222221222222221110212222201222222222222112211020222020022202202220122212220122102012222212202200222001222222212202000212000202112212122001222202121222022221021220201000222212220112222020121110202210222121021212002212212102021102010222220212212212220011222222202202022201012212212212121120202202022222122220022221212220212222222122222222021001211112222121221202122222102222221102212122221212202220222010222222212022210221122222212221022021222212122222022220120221221200202222211120222020122220220202222222221222012211112212222222212002120212220221222102222222222102120221110112222211120110202212020222222221122220202002202222201001222122222022210020222021020202102202012022021022022102020222212210222021222222212112102211101002212211220121202202021122122220221220221112212102200110222121222212221000222220002202202211012022220122110212220222221212220201222222222112200202001022102202022212222222121222222220120220212201202202201220222221122020210001222221121202112222222012122112002122022202212201220102222222212122210220202022212211222200222202020022022221022221221120222222200012222120022012212010222220201202012200202110021022102202022222201222222212222222202122001211010022002210202122212222221222222221021220222002222200211121222121022120211220222022122222212221222210122112101122022222210200222102222222202202212211201122002220221020212222122222022222221220212100200212200002222220022212200010222012121202112210212000122022122202020212200200221021222222202122202220002202202222212020212222121122022221122221221001202101220022222222121002211020222120001122002212212021220102212122222202220210220102222222222002120211122202112222202122200202020122022210220220210221211120200111222222022221221100222112001002112220202200021012111002021222220212221121222222202212111202200102222202012222210212022122122221220220201020210110212200222020121022220122222111122022122222002021020212111222020212201220222102222222202112212021211102012200201111200212020222222201221222221011220020201101222122220112202212222211212110212221022211220202022102022210222200220001222222212122101102112112012210002011221202022222222222021222220021221202210112222021122111212001222021221110212201002022022012022022021221210202222002222222212122201120022122122202221202202202020222012201022222202011221122212111222020021011221012222000121120112211212102020112201222021220201221220210222222212102010222021112022212212011200212121022212021120220222111212211202020222220220211210012222122211002002220022020121002201012121220220222221101222222212022121120100112102221112002210202220122212210021221222211221221211100222220021002220011222201111022212220102002020202102022222202210200222012122222202002020002211002012220000100221222020022022211020220100011201020210012222020121221221021222112210200102220022220221122201222220211202202221122222222202002011010020112002212021202220222221122020111021221122122110020202020222120120210222021222000010121002202112002120122020002221201200202220010122222012012111222010012002200221110222202220122200100221220112011111101221211222121220211211120222200112212212222222201022012202112222210200220220100022222002102200210100002002210211100202222220022101010120221112002000001221220222220122112210102222111201210222021022001120112011102220200212201222102222222002222022121201212212202122111211202221222201120020220111102020101201222222222220022222021222122102202002112212021021212001112221202200211220212022222102022021010022220022222120111201212222022120011222222102001221201201010222021020221221201222021022011202101222111222112121002121221220212222122222222221112111200101112202200011002221202221022020211020222022211011201112102222121122111212122222012112010102221102110120222211112120202200211221000020222002202202201100120012200210222210202020022022101121201212111010010021022222122021011220121222201000001202002012010120002200002221212201220222212220222120202112201021021012212220102201222121222100002122222002012121002010010222100120010211221222001100220212200222011020222222012222102222221220021022222211010010020211202022222211002200202010222022020020200212202220202002120222110222122201111222110111112222120202002120102210002120212212222221012121222221211001121012212202221122122211212202022012012220202202001210000201220222112121100210220222020212112102010122100120022110002222000220200222102021222000101022101200122202220122122221222010122201102120212111011201202122000222112021010212122222012110011202211002121021212220222121111220210220221120222120001022102011121202202100220221222111022022120220210121202122002122221222101121120201101222121010002202102212002121222201020021200220220220100020222010110000222201220012222122100202222002022010210020212222100001210121212222211220102202210222122112212112102202010120222012021022000211202221221121222001120111110100212122211010120200212000122101000122210022221201210012102222111222111220002222010210002122111012202121002021211100102210210220122120222110021001012211012002200100201220222112122000210122222122212011102010212222111020001200111222210111212112210202022022212112121212221221201200210021222000001120221020021112211212000220222220022021110022221102200100220021000222212220020110002222022002202112220102122022122120121001102222211211202020222212012222100221112102220021002220222100022101211220202120001012010122220222211022120002020222010201202012012222002121112212112220102210210211202021222112110021021202200012222012111211222011122112021022222121001102220211000222100220111112222222111010210212222012012122002010111001211201211221110022222112020012010001102212222111200212222212122020001020201120011211011220101222002022101211222222210112220002222122111120122210011111112202222220122220222212000202112022012012222010220221212021222002210021202002201221210110000022102121022102020220212201222022212002111021012201122202220211220202220021222101120222100201021222020221222002021002200102120011012020112200020221001200210010101010210011212210200111210020200200101020021121121000000002020102111221002201202200002100";

  @Test
  void day08Part1() {
    List<int[]> layers = toLayers(day08Input, 25, 6);
    var layerWithFewest0 = findLayerWithFewest0(layers);

    int checkProduct = calculateCheckProduct(layerWithFewest0);

    assertEquals(1742, checkProduct);
  }

  @Test
  void day08Part2() {
    List<int[]> layers = toLayers(day08Input, 25, 6);
    var layerWithFewest0 = findLayerWithFewest0(layers);

    var combinedLayer = combine(layers);

    printLayer(combinedLayer, 25, 6);
  }

  private void printLayer(int[] layer, int width, int height) {
    if(layer.length != width * height)
      throw new IllegalArgumentException("Layer size must be equal to width * height");

    int index = 0;
    for(var h = 0; h < height; h++) {
      for(var w = 0; w < width; w++) {
        final int color = layer[index++];
        if(color == 0) {
          System.out.print("   ");
        }
        if(color == 1) {
          System.out.print(" * ");
        }
      }
      System.out.println();
    }
  }

  private int[] combine(List<int[]> layers) {
    final var layerSize = layers.get(0).length;
    var combinedLayer = new int[layerSize];

    for(var i = 0; i < layerSize; i++) {
      var pixelsAtPosition = extractPixelsAtPosition(layers, i);
      var valueAtPosition = calculateValueAtPosition(pixelsAtPosition);
      combinedLayer[i] = valueAtPosition;
    }

    return combinedLayer;
  }

  private int calculateValueAtPosition(int[] pixelsAtPosition) {
    for (int pixel : pixelsAtPosition) {
      if(pixel != 2) {
        return pixel;
      }
    }
    return -1;
  }

  private int[] extractPixelsAtPosition(List<int[]> layers, int position) {
    final var pixelsAtPosition = new int[layers.size()];
    for(var i = 0; i < layers.size(); i++) {
      pixelsAtPosition[i] = layers.get(i)[position];
    }
    return pixelsAtPosition;
  }

  private int calculateCheckProduct(int[] layerWithFewest0) {
    final var countOf1 = countDigits(layerWithFewest0, 1);
    final var countOf2 = countDigits(layerWithFewest0, 2);
    return countOf1 * countOf2;
  }

  private int[] findLayerWithFewest0(List<int[]> layers) {
    int[] resultLayer = null;
    var minNmberOf0 = Integer.MAX_VALUE;

    for (var layer : layers) {
      var numberOf0 = countDigits(layer, 0);
      if(numberOf0 < minNmberOf0) {
        minNmberOf0 = numberOf0;
        resultLayer = layer;
      }
    }

    return resultLayer;
  }

  private int countDigits(int[] layer, int digit) {
    int zeros = 0;
    for (int i : layer) {
      if(i == digit) {
        zeros++;
      }
    }
    return zeros;
  }

  private List<int[]> toLayers(String input, int width, int height) {
    var pixelsPerLayer = width * height;
    var index = 0;
    var layers = new ArrayList<int[]>();
    while(index < input.length()) {
      int[] layer = new int[pixelsPerLayer];
      layers.add(layer);
      for (var i = 0; i < pixelsPerLayer; i++) {
        layer[i] = Character.getNumericValue(input.charAt(index++));
      }
    }
    return layers;
  }
}
